type Jest {
  """
  The source directory for the project.
  """
  pub source: Directory! @defaultPath(path: "/")

  """
  The base image to use.
  """
  pub baseImageAddress: String! = "node:25-alpine"

  """
  Execute the tests
  """
  pub test(files: [String!]! = []): Void @check {
    let cmd = ["npx", "jest"] + files

    let module = currentModule.source
    let build = container.from("oven/bun:1.3.0-alpine@sha256:37e6b1cbe053939bccf6ae4507977ed957eaa6e7f275670b72ad6348e0d2c11f").
      withMountedCache("/root/.npm", cacheVolume("library-node-modules")).
      withDirectory("/src", module).
      withWorkdir("/src").
      withExec(["bun", "install"]).
      withExec(["bun", "run", "build"]).
      directory("/src")

    base.
    withMountedDirectory("/jest", build).
    withExec(["npm", "install", "/jest"]).
    withEnvVariable("NODE_OPTIONS", "$NODE_OPTIONS --import @dagger.io/jest/register ", expand: true).
    withExec(cmd).
    sync

    null
  }

  """
  List the tests
  """
  pub list(): String {
    let cmd = ["npx", "jest", "--listTests"]

    base.
    withExec(cmd).
    stdout
  }

  let base: Container! {
    container.from(baseImageAddress).
      withMountedCache("/root/.npm", cacheVolume("node-modules")).
      withDirectory("/src", source).
      withWorkdir("/src").
      withEnvVariable("CI", "true").
      withExec(["npm", "install"])
  }
}
